---
title: "RNA-seq Analysis: `r params$experiment_name`"
subtitle: "Experimental Summary"
author: "Yildiz Lab RNA-seq Pipeline"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 3
    theme: default
    embed-resources: true
    fig-width: 8
    fig-height: 6
    df-print: paged
  pdf:
    toc: true
    geometry:
      - top=0.7in
      - right=0.7in
      - bottom=0.7in
      - left=0.7in
    fig-width: 7
    fig-height: 5
params:
  experiment_name: "experiment_template"
  report_data: NULL
  output_format: "html"
execute:
  echo: false
  warning: false
  message: false
---

```{r setup}
library(tidyverse)
library(DESeq2)
library(ComplexHeatmap)
library(plotly)
library(DT)
library(knitr)
library(scales)

# Extract data for convenience
experiment_metadata <- params$report_data$experiment$metadata
coldata <- params$report_data$experiment$coldata
pca_data <- params$report_data$plotting$pca
heatmap_data <- params$report_data$plotting$heatmap
comparison_summary <- params$report_data$plotting$comparison_summary
is_html <- params$output_format == "html"

# Set figure dimensions based on format
fig_width <- if (is_html) 8 else 7
fig_height <- if (is_html) 6 else 5
```

## Experiment Overview

**Analysis Date:** `r params$report_data$experiment$analysis_date`

**Dataset Summary:**

- **Samples:** `r experiment_metadata$n_samples`
- **Transcripts:** `r scales::comma(experiment_metadata$n_transcripts)`
- **Comparisons:** `r experiment_metadata$n_comparisons`
- **Design:** `r experiment_metadata$design_formula`

## Sample Information

```{r sample-table}
# Create formatted sample table
sample_table <- coldata %>%
  select(-files) %>%  # Remove file paths for cleaner display
  arrange(group)

if (is_html) {
  # Interactive table for HTML
  DT::datatable(
    sample_table,
    options = list(
      pageLength = 15,
      scrollX = TRUE,
      dom = 'Bfrtip'
    ),
    caption = "Sample metadata used in analysis"
  )
} else {
  # Static table for PDF
  kable(
    sample_table,
    caption = "Sample metadata used in analysis",
    booktabs = TRUE
  ) %>%
  kableExtra::kable_styling(
    latex_options = c("striped", "scale_down", "hold_position")
  )
}
```

## Principal Component Analysis

```{r pca-plot}
#| fig-cap: "PCA plot showing sample relationships"
#| fig-width: !expr fig_width
#| fig-height: !expr fig_height

# Create PCA plot
pca_plot <- pca_data$data %>%
  ggplot(aes(x = PC1, y = PC2, color = group, shape = strain)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(
    x = glue("PC1 ({pca_data$variance_explained[1]}%)"),
    y = glue("PC2 ({pca_data$variance_explained[2]}%)"),
    title = "Principal Component Analysis",
    subtitle = "Variance Stabilized Expression Data"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")

if (is_html) {
  # Interactive plot for HTML
  ggplotly(pca_plot, tooltip = c("sample", "group", "strain"))
} else {
  # Static plot for PDF
  print(pca_plot)
}
```

## Expression Heatmap

```{r heatmap}
#| fig-cap: "Heatmap of top 20 most variable genes"
#| fig-width: !expr fig_width
#| fig-height: !expr fig_height

# Prepare annotation for samples
sample_annotation <- HeatmapAnnotation(
  Group = heatmap_data$sample_annotation$group,
  Strain = heatmap_data$sample_annotation$strain,
  col = list(
    Group = rainbow(length(unique(heatmap_data$sample_annotation$group))) %>%
      set_names(unique(heatmap_data$sample_annotation$group)),
    Strain = rainbow(length(unique(heatmap_data$sample_annotation$strain))) %>%
      set_names(unique(heatmap_data$sample_annotation$strain))
  )
)

# Create heatmap
ht <- Heatmap(
  heatmap_data$matrix,
  name = "Z-score",
  top_annotation = sample_annotation,
  row_names_gp = gpar(fontsize = 8),
  column_names_gp = gpar(fontsize = 8),
  column_title = "Top 20 Most Variable Genes",
  heatmap_legend_param = list(title_position = "topcenter")
)

# Draw heatmap
draw(ht, heatmap_legend_side = "bottom")
```

## Comparison Summary

```{r comparison-summary-table}
# Format comparison summary
summary_table <- comparison_summary %>%
  mutate(
    total_genes = scales::comma(total_genes),
    max_log2fc = round(max_log2fc, 2),
    min_padj = scales::scientific(min_padj, digits = 2)
  ) %>%
  rename(
    "Comparison" = comparison,
    "Total Genes" = total_genes,
    "Significant" = sig_genes,
    "Differential" = de_genes,
    "Max |log2FC|" = max_log2fc,
    "Min padj" = min_padj
  )

if (is_html) {
  DT::datatable(
    summary_table,
    options = list(
      pageLength = 10,
      dom = 'Bfrtip'
    ),
    caption = "Summary statistics for each comparison"
  )
} else {
  kable(
    summary_table,
    caption = "Summary statistics for each comparison",
    booktabs = TRUE
  ) %>%
  kableExtra::kable_styling(
    latex_options = c("striped", "hold_position")
  )
}
```

## Individual Comparison Reports

```{r comparison-links, results='asis'}
if (is_html) {
  cat("### Links to Detailed Reports\n\n")
  
  for (comp_name in experiment_metadata$comparison_names) {
    cat(glue("- [{comp_name} Detailed Analysis]({comp_name}_report.html)\n"))
  }
} else {
  cat("### Available Detailed Reports\n\n")
  cat("Individual comparison reports are available as separate files:\n\n")
  
  for (comp_name in experiment_metadata$comparison_names) {
    cat(glue("- {comp_name}_report.pdf\n"))
  }
}
```

## Analysis Parameters

```{r analysis-params}
if (!is.null(params$report_data$experiment$config)) {
  config <- params$report_data$experiment$config$analysis
  
  param_table <- data.frame(
    Parameter = c(
      "Significance Threshold (padj)",
      "Log2 Fold Change Threshold",
      "Minimum Counts Filter",
      "LFC Shrinkage Method"
    ),
    Value = c(
      config$significance_threshold,
      config$log2FC_threshold,
      config$min_counts,
      config$lfcShrinkage_method
    )
  )
  
  kable(
    param_table,
    caption = "Analysis parameters used",
    booktabs = TRUE
  )
}
```