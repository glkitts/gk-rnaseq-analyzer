---
title: "`r params$experiment_name` - Interactive Gene Expression Heatmap"
format:
  html:
    theme: default
    toc: false
    embed-resources: true
    css: assets/styles.css
params:
  experiment_name: "experiment_name"
  data_dir: "path/to/data"
---

```{r setup, include=FALSE}
# Load required libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(DESeq2)
  library(plotly)
  library(heatmaply)
  library(here)
})

# Load report data
report_data <- read_rds(file.path(params$data_dir, paste0(params$experiment_name, "_report_data.RDS")))

# Extract key components
dds <- report_data$dds
coldata <- report_data$coldata
metadata <- report_data$metadata
```

```{r design-analysis, include=FALSE}
# Analyze the design to determine annotation factors
design_factors <- all.vars(design(dds))
design_factors <- design_factors[design_factors != "1"]

# Get available factors for annotation
available_factors <- colnames(coldata)
annotation_factors <- intersect(design_factors, available_factors)

if (length(annotation_factors) == 0) {
  annotation_factors <- available_factors
}
```

```{r data-prep, include=FALSE}
# Prepare normalized expression data
vsd <- vst(dds, blind = FALSE)
expr_matrix <- assay(vsd)

# Filter out genes with very low variance to reduce size
gene_vars <- rowVars(expr_matrix)
# Keep genes with variance above the 25th percentile
var_threshold <- quantile(gene_vars, 0.25)
keep_genes <- gene_vars > var_threshold

expr_matrix_filtered <- expr_matrix[keep_genes, ]

cat("Total genes:", nrow(expr_matrix), "\n")
cat("Genes after filtering:", nrow(expr_matrix_filtered), "\n")
cat("Genes removed (low variance):", nrow(expr_matrix) - nrow(expr_matrix_filtered), "\n")

# Prepare annotation data
annotation_data <- coldata %>%
  as.data.frame() %>%
  select(all_of(annotation_factors))

# Convert to character to avoid factor issues in heatmaply
annotation_data[] <- lapply(annotation_data, as.character)
```

## Interactive Gene Expression Heatmap

**Experiment:** `r params$experiment_name`
**Genes displayed:** `r format(nrow(expr_matrix_filtered), big.mark = ",")` (filtered from `r format(nrow(expr_matrix), big.mark = ",")` total)
**Samples:** `r metadata$n_samples`

This interactive heatmap shows variance-stabilized gene expression across all samples. Genes with very low variance have been filtered out to improve performance.

### Features:
- **Zoom:** Click and drag to zoom into regions
- **Hover:** Mouse over cells to see gene names, sample names, and expression values
- **Clustering:** Rows and columns are hierarchically clustered
- **Annotation:** Sample annotations are displayed as color bars

```{r interactive-heatmap, echo=FALSE, fig.width=12, fig.height=10}
# Create interactive heatmap
heatmaply(
  expr_matrix_filtered,
  col_side_colors = annotation_data,
  scale = "row",
  hclust_method = "complete",
  dist_method = "euclidean",
  showticklabels = c(FALSE, TRUE),  # Hide gene names (too many), show sample names
  margins = c(100, 50, 50, 50),
  plot_method = "plotly",
  fontsize_row = 6,
  fontsize_col = 8,
  main = paste(params$experiment_name, "- Gene Expression Heatmap"),
  xlab = "Samples",
  ylab = "Genes"
)
```

### Usage Tips:

1. **Zooming:** Use the zoom tools in the toolbar or click and drag to select a region
2. **Panning:** After zooming, drag to pan around the heatmap
3. **Reset:** Use the "Reset axes" button to return to full view
4. **Download:** Use the camera icon to download the current view as PNG

### Data Information:

- **Normalization:** Variance Stabilizing Transformation (VST)
- **Scaling:** Row-wise (per gene) z-scoring
- **Clustering:** Complete linkage hierarchical clustering
- **Filtering:** Genes with variance below 25th percentile removed

---

[← Back to Experimental Summary](`r params$experiment_name`_summary.html) | [← Back to Overview](../../overview.html)

*Generated by RNA-seq Enhanced Analysis Pipeline on `r Sys.Date()`*