---
title: "`r params$experiment_name` - Interactive Gene Expression Heatmap"
format:
  html:
    theme: default
    toc: false
    embed-resources: true
    css: assets/styles.css
params:
  experiment_name: "experiment_name"
  data_dir: "path/to/data"
---

```{r setup, include=FALSE}
# Load required libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(DESeq2)
  library(plotly)
  library(heatmaply)
  library(here)
})

# Load report data
report_data <- read_rds(file.path(params$data_dir, paste0(params$experiment_name, "_data.RDS")))

# Extract key components
dds <- report_data$dds
coldata <- report_data$coldata
metadata <- report_data$metadata
```

```{r design-analysis, include=FALSE}
# Analyze the design to determine annotation factors
design_factors <- all.vars(design(dds))
design_factors <- design_factors[design_factors != "1"]

# Get available factors for annotation
available_factors <- colnames(coldata)
annotation_factors <- intersect(design_factors, available_factors)

if (length(annotation_factors) == 0) {
  annotation_factors <- available_factors
}
```

```{r data-prep, include=FALSE}
# Prepare normalized expression data
vsd <- vst(dds, blind = FALSE)
expr_matrix <- assay(vsd)

# Intelligent gene selection for meaningful heatmap
genes_to_include <- character(0)

# 1. Get top differentially expressed genes across all comparisons
if (exists("res.l.all") && length(res.l.all) > 0) {
  all_de_genes <- res.l.all %>%
    map(~ .x$DE) %>%
    map(~ if(nrow(.x) > 0) .x$Label else character(0)) %>%
    unlist() %>%
    unique()

  # Take top 200 most significant DE genes
  top_de_genes <- res.l.all %>%
    map(~ .x$sig) %>%
    bind_rows() %>%
    arrange(padj) %>%
    head(200) %>%
    pull(Label) %>%
    unique()

  genes_to_include <- c(genes_to_include, top_de_genes)
  cat("Added", length(top_de_genes), "top DE genes\n")
}

# 2. Add genes from Yildiz lab pathways if available
if (exists("metadata") && "annotation_file" %in% names(metadata)) {
  # Try to get yildiz pathway genes from the data
  if (exists("res.l.all") && length(res.l.all) > 0) {
    yildiz_genes <- res.l.all[[1]]$all %>%
      filter(!is.na(yildiz_pathway)) %>%
      filter(yildiz_pathway != "") %>%
      head(100) %>%  # Limit to avoid too many
      pull(Label) %>%
      unique()

    genes_to_include <- c(genes_to_include, yildiz_genes)
    cat("Added", length(yildiz_genes), "Yildiz pathway genes\n")
  }
}

# 3. Add top variable genes as backup
gene_vars <- rowVars(expr_matrix)
top_var_genes <- names(sort(gene_vars, decreasing = TRUE))[1:300]
genes_to_include <- c(genes_to_include, top_var_genes)

# Remove duplicates and filter to genes that exist in the matrix
genes_to_include <- unique(genes_to_include)
genes_to_include <- genes_to_include[genes_to_include %in% rownames(expr_matrix)]

# Cap at 800 genes maximum for performance
if (length(genes_to_include) > 800) {
  genes_to_include <- genes_to_include[1:800]
}

# If still too few genes, add more variable genes
if (length(genes_to_include) < 200) {
  additional_genes <- setdiff(top_var_genes[1:400], genes_to_include)
  genes_to_include <- c(genes_to_include, additional_genes[1:(200 - length(genes_to_include))])
}

expr_matrix_filtered <- expr_matrix[genes_to_include, ]

cat("Total genes:", nrow(expr_matrix), "\n")
cat("Genes selected for heatmap:", nrow(expr_matrix_filtered), "\n")
cat("Selection includes: DE genes, Yildiz pathway genes, and high-variance genes\n")

# Prepare annotation data
annotation_data <- coldata %>%
  as.data.frame() %>%
  select(all_of(annotation_factors))

# Convert to character to avoid factor issues in heatmaply
annotation_data[] <- lapply(annotation_data, as.character)
```

## Interactive Gene Expression Heatmap

**Experiment:** `r params$experiment_name`
**Genes displayed:** `r format(nrow(expr_matrix_filtered), big.mark = ",")` (intelligently selected from `r format(nrow(expr_matrix), big.mark = ",")` total)
**Samples:** `r metadata$n_samples`

This interactive heatmap shows variance-stabilized gene expression across all samples. Genes are intelligently selected to include:
- Top differentially expressed genes across all comparisons
- Genes from Yildiz lab pathway annotations
- High-variance genes for additional biological insight

### Features:
- **Zoom:** Click and drag to zoom into regions
- **Hover:** Mouse over cells to see gene names, sample names, and expression values
- **Clustering:** Rows and columns are hierarchically clustered
- **Annotation:** Sample annotations are displayed as color bars

```{r interactive-heatmap, echo=FALSE, fig.width=12, fig.height=10}
# Create interactive heatmap
heatmaply(
  expr_matrix_filtered,
  col_side_colors = annotation_data,
  scale = "row",
  hclust_method = "complete",
  dist_method = "euclidean",
  showticklabels = c(FALSE, TRUE),  # Hide gene names (too many), show sample names
  margins = c(100, 50, 50, 50),
  plot_method = "plotly",
  fontsize_row = 6,
  fontsize_col = 8,
  main = paste(params$experiment_name, "- Gene Expression Heatmap"),
  xlab = "Samples",
  ylab = "Genes"
)
```

### Usage Tips:

1. **Zooming:** Use the zoom tools in the toolbar or click and drag to select a region
2. **Panning:** After zooming, drag to pan around the heatmap
3. **Reset:** Use the "Reset axes" button to return to full view
4. **Download:** Use the camera icon to download the current view as PNG

### Data Information:

- **Normalization:** Variance Stabilizing Transformation (VST)
- **Scaling:** Row-wise (per gene) z-scoring
- **Clustering:** Complete linkage hierarchical clustering
- **Gene Selection:** Intelligent filtering combining:
  - Top 200 most significant DE genes
  - Yildiz lab pathway genes
  - Top 300 high-variance genes
  - Maximum 800 genes for optimal performance

---

[← Back to Experimental Summary](`r params$experiment_name`_summary.html) | [← Back to Overview](../../overview.html)

*Generated by RNA-seq Enhanced Analysis Pipeline on `r Sys.Date()`*