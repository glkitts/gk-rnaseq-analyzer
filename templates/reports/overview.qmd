---
title: "`r params$experiment_name` - Analysis Overview"
format:
  html:
    theme: default
    toc: false
    embed-resources: true
params:
  experiment_name: "experiment_name"
  data_dir: "path/to/data"
---

```{r setup, include=FALSE}
# Load required libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(knitr)
  library(DT)
  library(here)
})

# Load report data
report_data <- read_rds(file.path(params$data_dir, paste0(params$experiment_name, "_report_data.RDS")))

# Extract key components
metadata <- report_data$metadata
res.l.all <- report_data$res.l.all
```

```{r summary-stats, include=FALSE}
# Calculate summary statistics
summary_stats <- list(
  n_samples = metadata$n_samples,
  n_genes = metadata$n_genes,
  n_comparisons = metadata$n_comparisons,
  analysis_date = metadata$analysis_date,
  design_formula = metadata$design_formula
)

# Count significant genes per comparison
sig_genes_summary <- map_dfr(names(res.l.all), function(comp_name) {
  res <- res.l.all[[comp_name]]$sig
  tibble(
    comparison = comp_name,
    n_significant = nrow(res),
    n_upregulated = sum(res$log2FoldChange > 0, na.rm = TRUE),
    n_downregulated = sum(res$log2FoldChange < 0, na.rm = TRUE)
  )
})

# Helper function for clean comparison names in links
clean_comparison_name <- function(comparison_name) {
  comparison_name %>%
    str_replace_all("[^a-zA-Z0-9_-]", "_") %>%
    str_replace_all("_{2,}", "_") %>%
    str_remove("^_+|_+$")
}
```

## Experiment Summary

**Analysis completed:** `r summary_stats$analysis_date`
**Design formula:** `r summary_stats$design_formula`

::: {.grid}

::: {.g-col-3}
**`r format(summary_stats$n_samples, big.mark = ",")`**
Samples
:::

::: {.g-col-3}
**`r format(summary_stats$n_genes, big.mark = ",")`**
Genes Tested
:::

::: {.g-col-3}
**`r summary_stats$n_comparisons`**
Comparisons
:::

::: {.g-col-3}
**`r sum(sig_genes_summary$n_significant)`**
Total Significant Genes
:::

:::

## Reports Available

### Main Reports
- [**Experimental Summary Report**](reports/html/`r params$experiment_name`_summary.html) - Sample QC, PCA, and overview of all comparisons
- [**Download Results (Excel)**](`r params$experiment_name`_DEcompilation.xlsx) - Complete results in spreadsheet format

### Individual Comparison Reports

```{r comparison-links, results='asis', echo=FALSE}
comparison_links <- map_chr(metadata$comparison_names, function(comp) {
  clean_name <- clean_comparison_name(comp)
  glue::glue("- [{comp}](reports/html/{params$experiment_name}_{clean_name}_DE.html)")
})

cat(paste(comparison_links, collapse = "\n"))
```

## Summary by Comparison

```{r comparison-table, echo=FALSE}
sig_genes_summary %>%
  rename(
    "Comparison" = comparison,
    "Significant Genes" = n_significant,
    "Upregulated" = n_upregulated,
    "Downregulated" = n_downregulated
  ) %>%
  knitr::kable(format = "html", table.attr = 'class="table table-striped"')
```

---

*Generated by RNA-seq Enhanced Analysis Pipeline on `r Sys.Date()`*