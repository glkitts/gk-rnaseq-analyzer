---
title: "`r params$experiment_name` - `r params$comparison_name`"
format:
  html:
    theme: default
    toc: true
    embed-resources: true
    css: assets/styles.css
    fig-width: 8
    fig-height: 6
    fig-dpi: 300
  pdf:
    toc: true
    number-sections: true
    fig-width: 6
    fig-height: 4.5
    fig-dpi: 300
params:
  experiment_name: "experiment_name"
  comparison_name: "comparison_name"
  data_dir: "path/to/data"
---

```{r setup, include=FALSE}
# Load required libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(DESeq2)
  library(ggplot2)
  library(knitr)
  library(DT)
  library(here)
  library(plotly)
  library(ggrepel)
  library(ComplexHeatmap)
  library(circlize)
})

# Source report functions
source(here("templates", "reports", "assets", "report_functions.R"))

# Load report data
report_data <- read_rds(file.path(params$data_dir, paste0(params$experiment_name, "_report_data.RDS")))

# Extract key components
dds <- report_data$dds
res.l.all <- report_data$res.l.all
coldata <- report_data$coldata
contrast_list <- report_data$contrast_list
gsea_results <- report_data$gsea_results
metadata <- report_data$metadata
config <- report_data$config_snapshot

# Get results for this comparison
comp_results <- res.l.all[[params$comparison_name]]
res_all <- comp_results$res.all
res_sig <- comp_results$res.sig

# Set global knitr options for publication quality
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  dpi = 300,
  dev = c("png", "pdf")
)
```

```{r comparison-analysis, include=FALSE}
# Find the contrast definition for this comparison
comparison_contrast <- NULL
for (i in seq_along(contrast_list)) {
  if (names(contrast_list)[i] == params$comparison_name) {
    comparison_contrast <- contrast_list[[i]]
    break
  }
}

# Extract comparison details
if (!is.null(comparison_contrast)) {
  factor_name <- comparison_contrast[1]
  numerator <- comparison_contrast[2]
  denominator <- comparison_contrast[3]
  comparison_description <- paste(numerator, "vs", denominator)
} else {
  comparison_description <- params$comparison_name
  factor_name <- "group"
  numerator <- "treatment"
  denominator <- "control"
}

# Calculate summary statistics
summary_stats <- create_summary_stats(res_all, res_sig, comparison_description)

# Set significance thresholds
sig_threshold <- if (!is.null(config$analysis$significance_threshold)) {
  config$analysis$significance_threshold
} else {
  0.05
}

fc_threshold <- if (!is.null(config$analysis$log2FC_threshold)) {
  config$analysis$log2FC_threshold
} else {
  1.0
}
```

## Comparison Overview

**Comparison:** `r comparison_description`
**Factor:** `r factor_name`
**Numerator (higher values):** `r numerator`
**Denominator (baseline):** `r denominator`

### Summary Statistics

::: {.grid}

::: {.g-col-3}
**`r format(summary_stats$"Genes Tested", big.mark = ",")`**
Genes Tested
:::

::: {.g-col-3}
**`r summary_stats$"Significant Genes"`**
Significant Genes
:::

::: {.g-col-3}
**`r summary_stats$Upregulated`**
Upregulated
:::

::: {.g-col-3}
**`r summary_stats$Downregulated`**
Downregulated
:::

:::

**Significance threshold:** Adjusted p-value < `r sig_threshold`
**Fold change threshold:** |log₂FC| ≥ `r fc_threshold`
**Percentage significant:** `r summary_stats$"% Significant"`%

## Volcano Plot

```{r volcano-plot}
#| fig-width: 8
#| fig-height: 6

p_volcano <- create_volcano_plot(
  res_all = res_all,
  res_sig = res_sig,
  comparison_name = comparison_description,
  sig_threshold = sig_threshold,
  fc_threshold = fc_threshold,
  interactive = FALSE
)

print(p_volcano)
```

### Interactive Volcano Plot

```{r volcano-interactive}
#| fig-width: 8
#| fig-height: 6

p_volcano_interactive <- create_volcano_plot(
  res_all = res_all,
  res_sig = res_sig,
  comparison_name = comparison_description,
  sig_threshold = sig_threshold,
  fc_threshold = fc_threshold,
  interactive = TRUE
)

p_volcano_interactive
```

## Top Differentially Expressed Genes

### Most Upregulated Genes

```{r top-up-genes}
n_up <- sum(res_sig$log2FoldChange > 0, na.rm = TRUE)

if (n_up > 0) {
  # Determine which label column to use
  label_cols <- c("yildiz_lbl", "label_rows", "Label", "gene_name", "gene_id")
  display_col <- NULL
  for (col in label_cols) {
    if (col %in% colnames(res_sig)) {
      display_col <- col
      break
    }
  }

  top_up <- res_sig %>%
    filter(log2FoldChange > 0) %>%
    arrange(padj) %>%
    head(10) %>%
    select(
      any_of(c(display_col, "log2FoldChange", "padj", "baseMean")),
      everything()
    )

  # Clean column names for display
  colnames(top_up) <- str_replace_all(colnames(top_up), c(
    "log2FoldChange" = "log₂FC",
    "padj" = "Adj. P-value",
    "baseMean" = "Base Mean"
  ))

  DT::datatable(
    top_up,
    options = list(
      pageLength = 10,
      scrollX = TRUE,
      dom = 't',
      columnDefs = list(
        list(className = 'dt-center', targets = 1:3)
      )
    ),
    caption = "Top 10 most significantly upregulated genes"
  ) %>%
  DT::formatSignif(columns = c("log₂FC", "Adj. P-value"), digits = 3) %>%
  DT::formatRound(columns = "Base Mean", digits = 0)
} else {
  cat("No significantly upregulated genes found.")
}
```

### Most Downregulated Genes

```{r top-down-genes}
n_down <- sum(res_sig$log2FoldChange < 0, na.rm = TRUE)

if (n_down > 0) {
  top_down <- res_sig %>%
    filter(log2FoldChange < 0) %>%
    arrange(padj) %>%
    head(10) %>%
    select(
      any_of(c(display_col, "log2FoldChange", "padj", "baseMean")),
      everything()
    )

  # Clean column names for display
  colnames(top_down) <- str_replace_all(colnames(top_down), c(
    "log2FoldChange" = "log₂FC",
    "padj" = "Adj. P-value",
    "baseMean" = "Base Mean"
  ))

  DT::datatable(
    top_down,
    options = list(
      pageLength = 10,
      scrollX = TRUE,
      dom = 't',
      columnDefs = list(
        list(className = 'dt-center', targets = 1:3)
      )
    ),
    caption = "Top 10 most significantly downregulated genes"
  ) %>%
  DT::formatSignif(columns = c("log₂FC", "Adj. P-value"), digits = 3) %>%
  DT::formatRound(columns = "Base Mean", digits = 0)
} else {
  cat("No significantly downregulated genes found.")
}
```

## Gene Set Enrichment Analysis

```{r gsea-section, results='asis'}
# Check if GSEA results exist for this comparison
gsea_available <- length(gsea_results) > 0
gsea_plots_created <- FALSE

if (gsea_available) {
  # Check for different GSEA types
  for (gsea_type in names(gsea_results)) {
    if (gsea_type %in% c("GObp", "GOmf", "KEGG")) {

      # Try to find results for this comparison
      gsea_data <- gsea_results[[gsea_type]]

      if (!is.null(gsea_data) && nrow(gsea_data) > 0) {
        # Filter for significant pathways
        sig_pathways <- gsea_data %>%
          filter(padj <= 0.05) %>%
          nrow()

        if (sig_pathways > 0) {
          gsea_plots_created <- TRUE

          cat("### ", case_when(
            gsea_type == "GObp" ~ "GO Biological Process",
            gsea_type == "GOmf" ~ "GO Molecular Function",
            gsea_type == "KEGG" ~ "KEGG Pathways",
            TRUE ~ str_to_title(gsea_type)
          ), "\n\n")

          # Calculate dynamic height
          plot_height <- calculate_pathway_plot_height(min(sig_pathways, 20))

          cat("```{r gsea-", gsea_type, "}\n")
          cat("#| fig-height: ", plot_height, "\n")
          cat("#| fig-width: 10\n\n")

          cat("p_gsea <- create_gsea_plot(\n")
          cat("  gsea_results$", gsea_type, ",\n", sep = "")
          cat("  comparison_name = comparison_description,\n")
          cat("  max_pathways = 20,\n")
          cat("  interactive = FALSE\n")
          cat(")\n\n")

          cat("if (!is.null(p_gsea)) {\n")
          cat("  print(p_gsea)\n")
          cat("} else {\n")
          cat("  cat('No significant pathways found for', gsea_type)\n")
          cat("}\n")
          cat("```\n\n")
        }
      }
    }
  }
}

if (!gsea_plots_created) {
  cat("### GSEA Results\n\n")
  cat("No significant gene set enrichment results available for this comparison.\n\n")
}
```

## Expression Heatmap of Significant Genes

```{r sig-genes-heatmap}
#| fig-width: 10
#| fig-height: !expr if(nrow(res_sig) <= 50) 8 else if(nrow(res_sig) <= 100) 10 else 12

n_significant <- nrow(res_sig)

if (n_significant > 0 && n_significant <= 100) {
  # Get expression data for significant genes
  vsd <- vst(dds, blind = FALSE)

  # Determine gene ID column
  gene_id_col <- if ("gene_id" %in% colnames(res_sig)) {
    "gene_id"
  } else if ("Label" %in% colnames(res_sig)) {
    "Label"
  } else {
    colnames(res_sig)[1]  # Fallback to first column
  }

  sig_genes <- res_sig[[gene_id_col]]

  if (length(sig_genes) > 0) {
    # Get expression matrix
    mat <- assay(vsd)[sig_genes, ]

    # Use gene names if available for row names
    label_cols <- c("yildiz_lbl", "label_rows", "Label", "gene_name")
    display_col <- NULL
    for (col in label_cols) {
      if (col %in% colnames(res_sig)) {
        display_col <- col
        break
      }
    }

    if (!is.null(display_col)) {
      gene_names <- res_sig[[display_col]][match(rownames(mat), res_sig[[gene_id_col]])]
      rownames(mat) <- ifelse(is.na(gene_names) | gene_names == "", rownames(mat), gene_names)
    }

    # Scale by row (gene)
    mat_scaled <- t(scale(t(mat)))

    # Create annotation for samples
    design_factors <- all.vars(design(dds))
    design_factors <- design_factors[design_factors != "1"]
    available_factors <- colnames(coldata)
    annotation_factors <- intersect(design_factors, available_factors)

    if (length(annotation_factors) > 0) {
      annotation_df <- coldata %>%
        as.data.frame() %>%
        select(all_of(annotation_factors))

      # Create color schemes
      annotation_colors <- list()
      for (factor in annotation_factors) {
        unique_vals <- unique(annotation_df[[factor]])
        if (is.factor(annotation_df[[factor]]) || is.character(annotation_df[[factor]])) {
          colors <- rainbow(length(unique_vals))
          names(colors) <- unique_vals
          annotation_colors[[factor]] <- colors
        }
      }

      top_annotation <- HeatmapAnnotation(
        df = annotation_df,
        col = annotation_colors,
        show_annotation_name = TRUE,
        annotation_name_gp = gpar(fontsize = 8),
        simple_anno_size = unit(0.3, "cm")
      )

      ht <- Heatmap(
        mat_scaled,
        name = "Z-score",
        top_annotation = top_annotation,
        show_row_names = n_significant <= 50,
        show_column_names = TRUE,
        column_title = paste("Expression of", n_significant, "Significant Genes"),
        row_names_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize = 8),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        use_raster = n_significant > 50,
        raster_quality = 3
      )
    } else {
      ht <- Heatmap(
        mat_scaled,
        name = "Z-score",
        show_row_names = n_significant <= 50,
        show_column_names = TRUE,
        column_title = paste("Expression of", n_significant, "Significant Genes"),
        row_names_gp = gpar(fontsize = 6),
        column_names_gp = gpar(fontsize = 8),
        cluster_rows = TRUE,
        cluster_columns = TRUE,
        use_raster = n_significant > 50,
        raster_quality = 3
      )
    }

    draw(ht)
  }
} else if (n_significant > 100) {
  cat("Too many significant genes (", n_significant, ") to display in heatmap. Showing top 50 by significance.\n\n")

  # Show top 50 genes
  vsd <- vst(dds, blind = FALSE)

  gene_id_col <- if ("gene_id" %in% colnames(res_sig)) {
    "gene_id"
  } else if ("Label" %in% colnames(res_sig)) {
    "Label"
  } else {
    colnames(res_sig)[1]
  }

  top_50_genes <- res_sig %>%
    arrange(padj) %>%
    head(50) %>%
    pull(!!sym(gene_id_col))

  if (length(top_50_genes) > 0) {
    mat <- assay(vsd)[top_50_genes, ]
    mat_scaled <- t(scale(t(mat)))

    # Simple heatmap for many genes
    ht <- Heatmap(
      mat_scaled,
      name = "Z-score",
      show_row_names = TRUE,
      show_column_names = TRUE,
      column_title = "Expression of Top 50 Most Significant Genes",
      row_names_gp = gpar(fontsize = 6),
      column_names_gp = gpar(fontsize = 8),
      use_raster = TRUE,
      raster_quality = 3
    )

    draw(ht)
  }
} else {
  cat("No significantly differentially expressed genes to display in heatmap.")
}
```

---

[← Back to Experimental Summary](`r params$experiment_name`_summary.html) | [← Back to Overview](../../overview.html)

*Generated by RNA-seq Enhanced Analysis Pipeline on `r Sys.Date()`*