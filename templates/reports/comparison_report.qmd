---
title: "`r params$experiment_name` - `r params$comparison_name`"
format:
  html:
    theme: default
    toc: true
    embed-resources: true
    css: assets/styles.css
    fig-width: 7
    fig-height: 5
    fig-dpi: 150
    out-width: "150%"
    out-height: "auto"
  pdf:
    toc: true
    number-sections: true
    fig-width: 8
    fig-height: 6
    fig-dpi: 300
params:
  experiment_name: "experiment_name"
  comparison_name: "comparison_name"
  data_dir: "path/to/data"
---

```{r setup, include=FALSE}
# Load required libraries
suppressPackageStartupMessages({
  library(tidyverse)
  library(DESeq2)
  library(ggplot2)
  library(knitr)
  library(DT)
  library(here)
  library(plotly)
  library(ggrepel)
  library(ComplexHeatmap)
  library(circlize)
  library(ggtext)
})

# Source report functions
source(here("functions", "report_functions.R"))

# Load report data
report_data <- read_rds(file.path(params$data_dir, paste0(params$experiment_name, "_data.RDS")))
# report_data <- read_rds("/Users/giordankitts/gk/yildizLab/projects_fy/gk-rnaseq-analyzer/experiments/LG_pmB/outputs/technical/R/LG_pmB_data.RDS")

# Extract key components
dds <- report_data$dds
res.l.all <- report_data$res.l.all
coldata <- report_data$coldata
contrast_list <- report_data$contrast_list
gsea_results <- report_data$gsea_results
metadata <- report_data$metadata
config <- report_data$config_snapshot

# Get results for this comparison
comp_results <- res.l.all[[params$comparison_name]]
if (is.null(comp_results)) {
  stop("Comparison '", params$comparison_name, "' not found in results. Available: ",
       paste(names(res.l.all), collapse = ", "))
}
res_all <- comp_results$all
res_sig <- comp_results$sig

# Set global knitr options for publication quality
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  dpi = 300,
  dev = c("png", "pdf")
)
```

```{r comparison-analysis, include=FALSE}
# Find the contrast definition for this comparison
comparison_contrast <- NULL
if (!is.null(names(contrast_list))) {
  for (i in seq_along(contrast_list)) {
    if (names(contrast_list)[i] == params$comparison_name) {
      comparison_contrast <- contrast_list[[i]]
      break
    }
  }
}

# Extract comparison details
if (!is.null(comparison_contrast)) {
  factor_name <- comparison_contrast[1]
  numerator <- comparison_contrast[2]
  denominator <- comparison_contrast[3]
  comparison_description <- paste(numerator, "vs", denominator)
} else {
  comparison_description <- params$comparison_name
  factor_name <- "group"
  numerator <- "treatment"
  denominator <- "control"
}

# Calculate summary statistics
summary_stats <- create_summary_stats(res_all, res_sig, comparison_description)

# Set significance thresholds
sig_threshold <- if (!is.null(config$analysis$significance_threshold)) {
  config$analysis$significance_threshold
} else {
  0.05
}

fc_threshold <- if (!is.null(config$analysis$log2FC_threshold)) {
  config$analysis$log2FC_threshold
} else {
  1.0
}
```

## Comparison Overview

::::: grid
::: g-col-6
**Comparison:** `r comparison_description`
:::

::: g-col-6
**Factor:** `r factor_name`
:::
:::::

### Summary Statistics

::::::: grid
::: g-col-3
**`r format(summary_stats$"Genes Tested", big.mark = ",")`** Genes Tested
:::

::: g-col-3
**`r summary_stats$"Significant Genes"`** Significant Genes
:::

::: g-col-3
**`r summary_stats$Upregulated`** Upregulated
:::

::: g-col-3
**`r summary_stats$Downregulated`** Downregulated
:::
:::::::

------------------------------------------------------------------------

:::::: grid
::: g-col-4
**Significance threshold:** Adjusted p-value \< `r sig_threshold`
:::

::: g-col-4
**Fold-change threshold:** \|log₂FC\| ≥ `r fc_threshold`
:::

::: g-col-4
**Percent significant:** `r summary_stats$"% Significant"`%
:::
::::::

## Volcano Plot

```{r volcano-plot}
#| fig-width: 6
#| fig-height: 4.5


p_volcano <- create_volcano_plot(
  res_all = res_all,
  res_sig = res_sig,
  comparison_name = comparison_description,
  sig_threshold = sig_threshold,
  fc_threshold = fc_threshold,
  interactive = FALSE
)

print(p_volcano)
```

::: {.content-visible when-format="html"}
### Interactive Volcano Plot

Can zoom and pan, hovering over points should show locus tag and differential expression values.

```{r volcano-interactive}
#| echo: false
#| eval: !expr knitr::is_html_output()

p_volcano_interactive <- create_volcano_plot(
  res_all = res_all,
  res_sig = res_sig,
  comparison_name = comparison_description,
  sig_threshold = sig_threshold,
  fc_threshold = fc_threshold,
  interactive = TRUE
)

p_volcano_interactive
```
:::

## Top Differentially Expressed Genes

### Most Upregulated Genes

```{r top-up-genes}
# Filter significant genes first (padj < 0.05), then get top 20 by strongest positive log2FC
sig_up_genes <- res_sig %>%
  filter(padj < 0.05, log2FoldChange > 0) %>%
  arrange(desc(log2FoldChange)) %>%
  head(20)

if (nrow(sig_up_genes) > 0) {
  # Determine which label column to use
  label_cols <- c("yildiz_lbl", "label_rows", "Label", "gene_name", "gene_id")
  display_col <- NULL
  for (col in label_cols) {
    if (col %in% colnames(sig_up_genes)) {
      display_col <- col
      break
    }
  }

  # Select only the 4 requested columns: Label, log2FC, p.adj, Product
  top_up <- sig_up_genes %>%
    select(
      Label = any_of(c(display_col, "Label")),
      log2FoldChange,
      padj,
      any_of("Product")
    )

  # Clean column names for display
  colnames(top_up) <- c("Label", "log₂FC", "Adj. P-value", "Product")

  # Format-conditional table output
  if (knitr::is_html_output()) {
    DT::datatable(
      top_up,
      options = list(
        pageLength = 20,
        scrollX = TRUE,
        dom = 't',
        columnDefs = list(
          list(className = 'dt-center', targets = 1:2)
        )
      ),
      caption = paste("Top", nrow(top_up), "most upregulated genes (by log₂FC strength, padj < 0.05)")
    ) %>%
    DT::formatSignif(columns = c("log₂FC", "Adj. P-value"), digits = 3)
  } else {
    top_up %>%
      mutate(across(c(`log₂FC`, `Adj. P-value`), ~signif(.x, 3))) %>%
      knitr::kable(
        caption = paste("Top", nrow(top_up), "most upregulated genes (by log₂FC strength, padj < 0.05)"),
        format = "pipe"
      )
  }
} else {
  cat("No significantly upregulated genes found (padj < 0.05).")
}
```

### Most Downregulated Genes

```{r top-down-genes}
# Filter significant genes first (padj < 0.05), then get top 20 by strongest negative log2FC
sig_down_genes <- res_sig %>%
  filter(padj < 0.05, log2FoldChange < 0) %>%
  arrange(log2FoldChange) %>%  # Most negative first
  head(20)

if (nrow(sig_down_genes) > 0) {
  # Select only the 4 requested columns: Label, log2FC, p.adj, Product
  top_down <- sig_down_genes %>%
    select(
      Label = any_of(c(display_col, "Label")),
      log2FoldChange,
      padj,
      any_of("Product")
    )

  # Clean column names for display
  colnames(top_down) <- c("Label", "log₂FC", "Adj. P-value", "Product")

  # Format-conditional table output
  if (knitr::is_html_output()) {
    DT::datatable(
      top_down,
      options = list(
        pageLength = 20,
        scrollX = TRUE,
        dom = 't',
        columnDefs = list(
          list(className = 'dt-center', targets = 1:2)
        )
      ),
      caption = paste("Top", nrow(top_down), "most downregulated genes (by log₂FC strength, padj < 0.05)")
    ) %>%
    DT::formatSignif(columns = c("log₂FC", "Adj. P-value"), digits = 3)
  } else {
    top_down %>%
      mutate(across(c(`log₂FC`, `Adj. P-value`), ~signif(.x, 3))) %>%
      knitr::kable(
        caption = paste("Top", nrow(top_down), "most downregulated genes (by log₂FC strength, padj < 0.05)"),
        format = "pipe"
      )
  }
} else {
  cat("No significantly downregulated genes found (padj < 0.05).")
}
```

## Gene Set Enrichment Analysis

### GO Biological Process

```{r gsea-gobp}
# Extract GObp GSEA results for this comparison
gsea_data <- NULL

# Navigate the nested data structure correctly
if (!is.null(gsea_results$GObp) &&
    !is.null(gsea_results$GObp$gsea_results) &&
    params$comparison_name %in% names(gsea_results$GObp$gsea_results)) {

  gsea_data <- gsea_results$GObp$gsea_results[[params$comparison_name]]
}

# Check if we have valid data
if (!is.null(gsea_data) && is.data.frame(gsea_data) && nrow(gsea_data) > 0) {

  # Filter for significant pathways with meaningful gene sets
  sig_pathways <- gsea_data %>%
    filter(padj <= 0.05, lengths(leadingEdge) > 2) %>%
    arrange(NES) %>%
    mutate(
      pathway_clean = str_replace(pathway, "\\(GO", " \\(GO"),
      pathway_clean = fct_inorder(pathway_clean)
    )

  if (nrow(sig_pathways) > 0) {

    # Calculate dynamic color and size scale limits based on actual data
    padj_range <- range(-log10(sig_pathways$padj))
    color_min <- max(0.5, floor(padj_range[1] * 10) / 10)  # Round down to nearest 0.1
    color_max <- ceiling(padj_range[2] * 10) / 10  # Round up to nearest 0.1

    size_range <- range(lengths(sig_pathways$leadingEdge))
    size_min <- floor(size_range[1] / 10) * 10  # Round down to nearest 10
    size_max <- ceiling(size_range[2] / 10) * 10  # Round up to nearest 10

    # Determine appropriate breaks for color scale
    color_breaks <- if (color_max - color_min > 4) {
      c(round(color_min), round((color_min + color_max) / 2), round(color_max))
    } else {
      c(round(color_min, 1), round(color_max, 1))
    }

    # Determine appropriate breaks for size scale
    size_breaks <- if (size_max > 60) {
      c(10, 30, 60)
    } else if (size_max > 30) {
      c(10, 30, size_max)
    } else {
      c(size_min, size_max)
    }

    # Create the plot with format-conditional styling
    # Use HTML tags only for HTML output
    color_label <- if (knitr::is_html_output()) {
      "-log<sub>10</sub>(padj)"
    } else {
      "-log10(padj)"
    }

    size_label <- if (knitr::is_html_output()) {
      "Leading Edge<br>Genes"
    } else {
      "Leading Edge\nGenes"
    }

    p <- ggplot(sig_pathways, aes(
      x = NES,
      y = pathway_clean,
      color = -log10(padj),
      size = lengths(leadingEdge)
    )) +
      geom_point() +
      viridis::scale_color_viridis(
        name = color_label,
        limits = c(color_min, color_max),
        breaks = color_breaks,
        option = "viridis",
        oob = scales::oob_squish
      ) +
      scale_size_continuous(
        name = size_label,
        range = c(2, 8),
        limits = c(size_min, size_max),
        breaks = size_breaks
      ) +
      scale_x_continuous(
        name = "Normalized Enrichment Score (NES)",
        limits = c(-3, 3)
      ) +
      labs(
        title = paste("GO Biological Process Enrichment:", comparison_description),
        y = NULL,
        subtitle = paste(nrow(sig_pathways), "significant pathways (padj <= 0.05, >2 genes)")
      ) +
      theme_report() +
      theme(
        legend.position = "right",
        legend.direction = "vertical",
        legend.box = "vertical",
        legend.title = element_text(size = rel(0.9)),
        # axis.text.y = element_text(size = rel(0.75)),
        legend.background = element_rect(fill = NA),
        plot.margin = margin(10, 10, 10, 10)
      )

    # Apply markdown theme only for HTML
    if (knitr::is_html_output()) {
      p <- p + pt.mdtext
    }

    p <- p + coord_cartesian(clip = "off")

    print(p)

  } else {
    cat("No significant GO Biological Process pathways found (padj ≤ 0.05 with >2 leading edge genes).\n")
  }

} else {
  cat("No GSEA results available for this comparison.\n")
}
```

------------------------------------------------------------------------

[← Back to Experimental Summary](`r params$experiment_name`_experimental_summary.html) | [← Back to Overview](../../overview.html)

*Generated by RNA-seq Enhanced Analysis Pipeline on `r Sys.Date()`*
