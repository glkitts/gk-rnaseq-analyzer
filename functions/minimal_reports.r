#!/usr/bin/env Rscript

# Minimal report generation for testing
# Use this for initial testing before implementing full system

#' Generate minimal experimental summary report
#' 
#' Simplified version that creates a basic HTML report without complex data processing
generate_minimal_summary <- function(experiment_name, res.l.all, dds, coldata) {
  
  # Create basic summary data
  summary_data <- list(
    experiment_name = experiment_name,
    n_samples = ncol(dds),
    n_transcripts = nrow(dds),
    n_comparisons = length(res.l.all),
    analysis_date = Sys.Date(),
    comparison_summary = res.l.all %>%
      imap_dfr(function(comp_data, comp_name) {
        tibble(
          comparison = comp_name,
          total_genes = nrow(comp_data$all),
          sig_genes = nrow(comp_data$sig),
          de_genes = nrow(comp_data$DE)
        )
      })
  )
  
  # Create simple HTML report
  html_content <- glue::glue(
    "<!DOCTYPE html>
    <html>
    <head>
      <title>RNA-seq Analysis: {summary_data$experiment_name}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { color: #333; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
      </style>
    </head>
    <body>
      <h1>RNA-seq Analysis: {summary_data$experiment_name}</h1>
      <p><strong>Analysis Date:</strong> {summary_data$analysis_date}</p>
      
      <h2>Experiment Overview</h2>
      <ul>
        <li><strong>Samples:</strong> {summary_data$n_samples}</li>
        <li><strong>Transcripts:</strong> {scales::comma(summary_data$n_transcripts)}</li>
        <li><strong>Comparisons:</strong> {summary_data$n_comparisons}</li>
      </ul>
      
      <h2>Comparison Summary</h2>
      <table>
        <tr>
          <th>Comparison</th>
          <th>Total Genes</th>
          <th>Significant</th>
          <th>Differential</th>
        </tr>
        {paste(apply(summary_data$comparison_summary, 1, function(row) {
          glue::glue('<tr><td>{row[1]}</td><td>{row[2]}</td><td>{row[3]}</td><td>{row[4]}</td></tr>')
        }), collapse = '\n        ')}
      </table>
      
      <h2>Individual Reports</h2>
      <ul>
        {paste(map_chr(names(res.l.all), ~ glue::glue('<li><a href=\"{.x}_minimal.html\">{.x}</a></li>')), collapse = '\n        ')}
      </ul>
      
      <p><em>Generated by Yildiz Lab RNA-seq Pipeline</em></p>
    </body>
    </html>"
  )
  
  # Save HTML file
  reports_dir <- here::here("experiments", experiment_name, "outputs", "reports")
  if (!dir.exists(reports_dir)) {
    dir.create(reports_dir, recursive = TRUE)
  }
  
  output_file <- file.path(reports_dir, paste0(experiment_name, "_minimal_summary.html"))
  writeLines(html_content, output_file)
  
  cli::cli_inform("Generated minimal summary: {basename(output_file)}")
  return(output_file)
}

#' Generate minimal comparison report
generate_minimal_comparison <- function(comparison_name, comparison_data, experiment_name) {
  
  results <- comparison_data$results
  contrast <- comparison_data$contrast
  
  # Create simple HTML report
  html_content <- glue::glue(
    "<!DOCTYPE html>
    <html>
    <head>
      <title>Differential Expression: {comparison_name}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { color: #333; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .number { text-align: right; }
      </style>
    </head>
    <body>
      <h1>Differential Expression: {comparison_name}</h1>
      <p><strong>Comparison:</strong> {contrast[2]} vs {contrast[3]}</p>
      
      <h2>Summary</h2>
      <ul>
        <li><strong>Total genes:</strong> {scales::comma(nrow(results$all))}</li>
        <li><strong>Significant (padj ≤ 0.05):</strong> {nrow(results$sig)}</li>
        <li><strong>Differentially expressed:</strong> {nrow(results$DE)}</li>
      </ul>
      
      <h2>Top 10 Differentially Expressed Genes</h2>
      <table>
        <tr>
          <th>Gene</th>
          <th>Product</th>
          <th>log2FC</th>
          <th>padj</th>
        </tr>
        {
          if (nrow(results$DE) > 0) {
            top_genes <- results$DE %>%
              arrange(padj) %>%
              slice_head(n = 10) %>%
              select(Label, any_of('Product'), log2FoldChange, padj) %>%
              mutate(
                log2FoldChange = round(log2FoldChange, 3),
                padj = scales::scientific(padj, digits = 2)
              )
            
            paste(apply(top_genes, 1, function(row) {
              product <- if('Product' %in% names(row)) row[['Product']] else 'N/A'
              glue::glue('<tr><td>{row[[\"Label\"]]}</td><td>{product}</td><td class=\"number\">{row[[\"log2FoldChange\"]]}</td><td class=\"number\">{row[[\"padj\"]]}</td></tr>')
            }), collapse = '\n        ')
          } else {
            '<tr><td colspan=\"4\">No differentially expressed genes found</td></tr>'
          }
        }
      </table>
      
      <p><a href=\"{experiment_name}_minimal_summary.html\">← Back to Summary</a></p>
      <p><em>Generated by Yildiz Lab RNA-seq Pipeline</em></p>
    </body>
    </html>"
  )
  
  # Save HTML file
  reports_dir <- here::here("experiments", experiment_name, "outputs", "reports")
  output_file <- file.path(reports_dir, paste0(comparison_name, "_minimal.html"))
  writeLines(html_content, output_file)
  
  cli::cli_inform("Generated minimal comparison: {basename(output_file)}")
  return(output_file)
}

#' Generate all minimal reports
generate_minimal_reports <- function(experiment_name, res.l.all, dds, coldata, contrast_list) {
  
  cli::cli_inform("Generating minimal reports for {experiment_name}...")
  
  # Add contrast info to results
  res.l.all.with_contrast <- res.l.all %>%
    imap(function(comp_data, comp_name) {
      # Find matching contrast
      contrast_idx <- which(sapply(contrast_list, function(c) {
        format_comparison_name(c) == comp_name
      }))
      
      if (length(contrast_idx) > 0) {
        comp_data$contrast <- contrast_list[[contrast_idx[1]]]
      } else {
        # Fallback - try to parse from name
        parts <- str_split(comp_name, "_v_")[[1]]
        if (length(parts) == 2) {
          comp_data$contrast <- c("group", parts[1], parts[2])
        } else {
          comp_data$contrast <- c("unknown", "treatment", "control")
        }
      }
      
      comp_data
    })
  
  # Generate summary report
  summary_file <- generate_minimal_summary(experiment_name, res.l.all, dds, coldata)
  
  # Generate individual comparison reports
  comparison_files <- res.l.all.with_contrast %>%
    imap(function(comp_data, comp_name) {
      generate_minimal_comparison(comp_name, comp_data, experiment_name)
    })
  
  cli::cli_inform("Generated {length(comparison_files) + 1} minimal report files")
  cli::cli_inform("Open summary: experiments/{experiment_name}/outputs/reports/{experiment_name}_minimal_summary.html")
  
  return(c(summary = summary_file, comparison_files))
}
